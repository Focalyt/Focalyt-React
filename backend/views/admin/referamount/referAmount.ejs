<% include ../partials/header %>

<div class="content-header row d-xl-block d-lg-block d-md-none d-sm-none d-none">
  <div class="content-header-left col-md-9 col-12 mb-2">
    <div class="row breadcrumbs-top">
      <div class="col-12">
        <h3 class="content-header-title float-left mb-0">Referral Share Offers</h3>
        <div class="breadcrumb-wrapper col-12">
          <ol class="breadcrumb">
            <li class="breadcrumb-item">
              <a href="<%= process.env.MIPIE_BACKEND_URL %>/admin">Home</a>
            </li>
            <li class="breadcrumb-item active">Referral Share Offers</li>
          </ol>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="content-body">
  <% include ../partials/flash %>

  <section class="list-view">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h4 class="card-title mb-0">Create referral amount for every share</h4>
          </div>
          <div class="card-body">
            <ul class="nav nav-tabs" id="referOfferTabs" role="tablist">
              <li class="nav-item">
                <a class="nav-link active" id="job-offer-tab" data-toggle="tab" href="#job-offer" role="tab" aria-controls="job-offer" aria-selected="true">
                  Job Offer
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" id="course-offer-tab" data-toggle="tab" href="#course-offer" role="tab" aria-controls="course-offer" aria-selected="false">
                  Course Offer
                </a>
              </li>
            </ul>

            <div class="tab-content pt-2">
              <!-- Job Offer -->
              <div class="tab-pane fade show active" id="job-offer" role="tabpanel" aria-labelledby="job-offer-tab">
                <div class="d-flex justify-content-end mb-1">
                  <button class="btn btn-primary" type="button" data-toggle="modal" data-target="#createJobOfferModal">
                    Create Job Offer
                  </button>
                </div>

                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th style="width: 60px;">#</th>
                        <th>Referrer Reward (₹)</th>
                        <th>Referred Reward (₹)</th>
                        <th>Status</th>
                        <th>Note</th>
                        <th>Created At</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if (jobOffers && jobOffers.length > 0) { %>
                        <% jobOffers.forEach((offer, idx) => { %>
                          <tr>
                            <td><%= idx + 1 %></td>
                            <td><%= (offer.referrerAmount ?? offer.amount ?? 0) %></td>
                            <td><%= (offer.referredAmount ?? 0) %></td>
                            <td>
                              <% if (offer.isActive) { %>
                                <span class="badge badge-success">Active</span>
                              <% } else { %>
                                <span class="badge badge-secondary">Inactive</span>
                              <% } %>
                            </td>
                            <td><%= offer.note || '-' %></td>
                            <td><%= moment(offer.createdAt).utcOffset('+05:30').format('DD MMM YYYY, hh:mm A') %></td>
                            <td>
                              <div class="d-flex gap-1">
                                <% if (offer.isActive) { %>
                                  <button class="btn btn-warning btn-sm text-white" onclick="toggleOfferStatus('<%= offer._id %>', 'JOB', false)" title="Deactivate">
                                    <i class="feather icon-x mr-50"></i> Deactivate
                                  </button>
                                <% } else { %>
                                  <button class="btn btn-success btn-sm text-white" onclick="toggleOfferStatus('<%= offer._id %>', 'JOB', true)" title="Activate">
                                    <i class="feather icon-check mr-50"></i> Activate
                                  </button>
                                <% } %>
                              </div>
                            </td>
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr>
                          <td colspan="7" class="text-center">No job offers created yet.</td>
                        </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Course Offer -->
              <div class="tab-pane fade" id="course-offer" role="tabpanel" aria-labelledby="course-offer-tab">
                <div class="d-flex justify-content-end mb-1">
                  <button class="btn btn-primary" type="button" data-toggle="modal" data-target="#createCourseOfferModal">
                    Create Course Offer
                  </button>
                </div>

                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th style="width: 60px;">#</th>
                        <th>Referrer Reward (₹)</th>
                        <th>Referred Reward (₹)</th>
                        <th>Status</th>
                        <th>Note</th>
                        <th>Created At</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% if (courseOffers && courseOffers.length > 0) { %>
                        <% courseOffers.forEach((offer, idx) => { %>
                          <tr>
                            <td><%= idx + 1 %></td>
                            <td><%= (offer.referrerAmount ?? offer.amount ?? 0) %></td>
                            <td><%= (offer.referredAmount ?? 0) %></td>
                            <td>
                              <% if (offer.isActive) { %>
                                <span class="badge badge-success">Active</span>
                              <% } else { %>
                                <span class="badge badge-secondary">Inactive</span>
                              <% } %>
                            </td>
                            <td><%= offer.note || '-' %></td>
                            <td><%= moment(offer.createdAt).utcOffset('+05:30').format('DD MMM YYYY, hh:mm A') %></td>
                            <td>
                              <div class="d-flex gap-1">
                                <% if (offer.isActive) { %>
                                  <button class="btn btn-warning btn-sm text-white" onclick="toggleOfferStatus('<%= offer._id %>', 'COURSE', false)" title="Deactivate">
                                    <i class="feather icon-x mr-50"></i> Deactivate
                                  </button>
                                <% } else { %>
                                  <button class="btn btn-success btn-sm text-white" onclick="toggleOfferStatus('<%= offer._id %>', 'COURSE', true)" title="Activate">
                                    <i class="feather icon-check mr-50"></i> Activate
                                  </button>
                                <% } %>
                              </div>
                            </td>
                          </tr>
                        <% }) %>
                      <% } else { %>
                        <tr>
                          <td colspan="7" class="text-center">No course offers created yet.</td>
                        </tr>
                      <% } %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Create Job Offer Modal -->
<div class="modal fade" id="createJobOfferModal" tabindex="-1" role="dialog" aria-labelledby="createJobOfferModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="POST" action="<%= process.env.MIPIE_BACKEND_URL %>/admin/referAmount/jobOffer">
        <div class="modal-header">
          <h5 class="modal-title" id="createJobOfferModalLabel">Create Job Offer</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Referrer Reward per Job Apply (₹) <span class="asterisk">*</span></label>
            <input type="number" name="referrerAmount" class="form-control" min="0" step="1" required />
          </div>
          <div class="form-group">
            <label>Referred Reward per Job Apply (₹) <span class="asterisk">*</span></label>
            <input type="number" name="referredAmount" class="form-control" min="0" step="1" required />
          </div>
          <div class="form-group">
            <label>Note</label>
            <textarea name="note" class="form-control" rows="3" placeholder="Optional note..."></textarea>
          </div>
          <div class="form-group mb-0">
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="jobIsActive" name="isActive" checked>
              <label class="custom-control-label" for="jobIsActive">Set as Active</label>
            </div>
            <small class="text-muted">If active, older offers of the same type will be marked inactive.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create Course Offer Modal -->
<div class="modal fade" id="createCourseOfferModal" tabindex="-1" role="dialog" aria-labelledby="createCourseOfferModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <form method="POST" action="<%= process.env.MIPIE_BACKEND_URL %>/admin/referAmount/courseOffer">
        <div class="modal-header">
          <h5 class="modal-title" id="createCourseOfferModalLabel">Create Course Offer</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Referrer Reward per Course Apply (₹) <span class="asterisk">*</span></label>
            <input type="number" name="referrerAmount" class="form-control" min="0" step="1" required />
          </div>
          <div class="form-group">
            <label>Referred Reward per Course Apply (₹) <span class="asterisk">*</span></label>
            <input type="number" name="referredAmount" class="form-control" min="0" step="1" required />
          </div>
          <div class="form-group">
            <label>Note</label>
            <textarea name="note" class="form-control" rows="3" placeholder="Optional note..."></textarea>
          </div>
          <div class="form-group mb-0">
            <div class="custom-control custom-checkbox">
              <input type="checkbox" class="custom-control-input" id="courseIsActive" name="isActive" checked>
              <label class="custom-control-label" for="courseIsActive">Set as Active</label>
            </div>
            <small class="text-muted">If active, older offers of the same type will be marked inactive.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
    div.modal-content {
    text-align: left;
    }
    .gap-1 {
        gap: 0.25rem;
    }
</style>

<script>
function toggleOfferStatus(offerId, offerType, activate) {
    const action = activate ? 'activate' : 'deactivate';
    const confirmMsg = activate 
        ? 'Are you sure you want to activate this offer? This will deactivate all other active offers of the same type.'
        : 'Are you sure you want to deactivate this offer?';
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    fetch(`<%= process.env.MIPIE_BACKEND_URL %>/admin/referAmount/${offerId}/toggleStatus`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
            isActive: activate,
            offerType: offerType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || `Offer ${action}d successfully!`);
            location.reload();
        } else {
            alert('Error: ' + (data.message || `Failed to ${action} offer`));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`Error ${action}ing offer. Please try again.`);
    });
}
</script>

<% include ../partials/footer %>

</body>
</html>
